<extend name="Common:base" />

<block name='css'>
<style type="text/css">
	body{
		background: url(__PUBLIC__/img/bg.jpg) fixed no-repeat;
	}
</style>
</block>

<block name="main">
<div class="am-g">

<h2 style="margin: 0 auto;max-width: 1040px;margin-top: 2rem;">时光碎片 {$data.share_id}</h2>
<div style="margin: 0 auto;max-width: 1040px;margin-top: 2rem;">
  <div class="am-u-md-8">
  	<p class="am-text-sm am-fl">@{$data.user_id|get_nickname} 发表在 <a href="">{$data.catalog_id|get_catalog_name}</a> 于 {$data.create_time|get_timing}前</p>
  	<if condition="get_auth('delete', 0, $data['share_id'])">
    <div class="am-btn-group am-btn-group-xs am-fr">
		  <a href="{:U('Shard/modi','share_id='.I('get.id'))}" class="am-btn am-radius am-btn-secondary">修改</a>
		  <a id="del" class="am-btn am-radius">删除</a>
		</div>
  	</if>
  	<a href="__PUBLIC__/{$data.savepath}{$data.savename}" data-lightbox="image-1" title="{$data.tag_id|get_tag}" data-title="{$data.detail}">
			<img class="am-img-responsive" style="display: inherit;" src="__PUBLIC__/{$data.savepath}{$data.savename}"/>
  	</a>
  	<h5>{$data.tag_id|show_tag}</h5>
		<p>{$data.detail}</p>

    <hr class="am-article-divider blog-hr">
<volist name="comment" id="vo">
		<article class="am-comment">
		  <a href="{:U('User/index','user_id='.$vo['user_id'])}">
		    <img class="am-comment-avatar" alt=""/> <!-- 评论者头像 -->
		  </a>

		  <div class="am-comment-main">
		    <header class="am-comment-hd">
		      <div class="am-comment-meta am-fl">
		        <a href="{:U('User/index','user_id='.$vo['user_id'])}" class="am-comment-author">{$vo.user_id|get_nickname}</a>
		        评论于 {$vo.create_time|time_format}
		      </div>
		      <if condition="get_auth('manage_comment', 0, $vo['comment_id'])">
		      <div class="am-fr am-vertical-align">
		      	<a id="del-comment" class="am-text-sm am-vertical-align-middle am-badge" data-id="{$vo.comment_id}" style="margin-right: 1rem;">删除该条 <i class="am-icon-times"></i></a>
		      </div>
		      </if>
		    </header>

		    <div class="am-comment-bd">{$vo.detail}</div>
		  </div>
		</article>
		<br />
</volist>

		<form class="am-form" data-am-validator>
			<fieldset>
			<div class="am-form-group">
	      <label for="doc-ta-1">我要吐槽 <span class="am-text-sm am-text-warning">请合理吐槽</span></label>
	      <textarea id="detail-val" minlength="2" maxlength="255" class="" rows="5" id="doc-ta-1" placeholder="请不要超过255字"></textarea>
	    </div>
			<input type="button" class="am-btn am-btn-primary" value="吐" onclick="return submitComment();"></input>
			</fieldset>
		</form>

  </div>

  <div class="am-u-md-4 blog-sidebar">
    <div class="am-panel-group">
      <section class="am-panel am-panel-default">
        <div class="am-panel-hd">
        	<span class="am-badge-primary am-badge">{$data.user_id|get_usergroup=0}</span> <a href="{:U('User/index','user_id'.$data['user_id'])}">@{$data.user_id|get_nickname}</a><br />
        	<span class="am-text-sm">关注：{$user.like|default='0'} 粉丝：{$user.be_like} 分享：{$user.total_share}</span>
        </div>
        <div class="am-panel-bd">
          <p>{$user.detail|default="碎片主人很懒，什么也没有留下。"}</p>
          <a class="am-btn am-btn-success am-btn-xs" href="#">查看更多信息 →</a>
        </div>
      </section>

    </div>
  </div>
</div>

<div class="am-modal am-modal-confirm" tabindex="-1" id="my-confirm">
  <div class="am-modal-dialog">
    <div class="am-modal-hd">天佑时光轴</div>
    <div class="am-modal-bd">
      你，确定要删除这条记录吗？
    </div>
    <div class="am-modal-footer">
      <span class="am-modal-btn" data-am-modal-cancel>不不不</span>
      <span class="am-modal-btn" data-am-modal-confirm style="color: #dd514c;"><i class="am-icon-remove"></i> 无情删除</span>
    </div>
  </div>
</div>

</div>
</block>

<block name='js'>
<script src="__PUBLIC__/js/lightbox.js" type="text/javascript" charset="utf-8"></script>
<script type="text/javascript">
$(function() {
  $('#del').on('click', function() {
  	var share_id = {:I('get.id')};
    $('#my-confirm').modal({
      relatedTarget: this,
      onConfirm: function(options) {
        $.ajax({
        	url: "{:U('Shard/del')}",
        	data: {'share_id': share_id},
        	success: function(data) {
        		if(data.status){
        			alert('删除成功');
          		window.location.href = "{:U('Index/index')}";
        		} else {
        			alert(data.info);
        		}
        	}
        });
      }
    });
  });
   $('#del-comment').on('click', function() {
  	var comment_id = $(this).attr('data-id');
    $('#my-confirm').modal({
      onConfirm: function(options) {
        $.ajax({
        	url: "{:U('Shard/delete_comment')}",
        	data: {'comment_id': comment_id},
        	success: function(data) {
        		if(data.status){
        			alert(data.info);
          		window.location.reload();
        		} else {
        			alert(data.info);
        		}
        	}
        });
      }
    });
  });
});
var submitComment = function() {
	var share_id = {:I('get.id')};
	$.ajax({
		url:"{:U('Shard/submit_comment')}",
		data:{
			"share_id": share_id,
			"detail": $("#detail-val").val()
		},
		success: function( data ) {
			if(data.status) {
				alert(data.info);
				window.location.reload();
			} else {
				alert(data.info);
			}
		}
	});
	return false;
}
</script>
</block>
