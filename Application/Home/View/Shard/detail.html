<extend name="Common:base" />

<block name="css">
<link rel="stylesheet" href="__PUBLIC__/css/imgbox.css" />
</block>

<block name="top-fixed"></block>

<block name="main">
<div class="am-g shard-detail">

<h2>时光碎片 {$data.share_id} : <span class="am-text-lg am-margin-left">{$data.tag_id|show_tag}</span></h2>

<div class="content">
  <div class="am-u-md-8 share">
  	<div class="am-g">
	  	<p class="am-text-sm am-fl info">
	  		<a class="am-text-warning" href="{:U('User/index','user_id'.$data['user_id'])}">@{$data.user_id|get_nickname}</a>
	  		发表在 <a href="{:U('Catalog/detail')}?id={$data.catalog_id}">{$data.catalog_id|get_catalog_name}</a>
	  		于 {$data.create_time|get_timing}前
	  	</p>
	  	<if condition="get_auth('delete', 0, $data['share_id'])">
	    <div class="am-btn-group am-btn-group-xs am-fr">
			  <a href="{:U('Shard/modi','share_id='.I('get.id'))}" class="am-btn am-radius am-btn-secondary">修改</a>
			  <button class="am-btn am-radius am-btn-link" onclick="deleteShare({$data.share_id})" style="color: #ccc;">删除</button>
			</div>
	  	</if>
  	</div>
  	<div class="am-g">
			<a id="imgbox" href="__PUBLIC__/{$data.savepath}{$data.savename}" title="{$data.tag_id|get_tag}">
				<img class="am-img-responsive" style="padding: 10px;background-color: white;" alt="{$data.tag_id|str2json|get_tag}" src="__PUBLIC__/{$data.savepath}{$data.savename}" />
			</a>
			<p style="padding: 8px;margin: 0;">拍摄于 {$data.time|time_format='Y 年 n 月 j 日 H:i'}</p>
  	</div>
  	<if condition="strlen($data['detail']) gt 0">
		<div class="am-g">
			<p class="detail">{$data.detail}</p>
		</div>
  	</if>

		<div id="imgbox-info" class="am-hide">
			<div class="am-g" style="background-color: #CECECE;">
				<div class="tag am-fl am-margin-left-sm">{$data.tag_id|show_tag}</div>
				<div class="author am-fr am-margin-right">{$data.create_time|time_format='Y 年 m 月 d 日 H:i'} 由 @{$data.user_id|get_nickname} 发表于 {$data.create_time|get_timing}前</div>
			</div>
			<div class="detail am-text-default am-text-truncate" style="text-indent: 1.5em;">{$data.detail}</div>
		</div>


    <div class="am-g">
    	<hr class="am-article-divider blog-hr">

			<volist name="comment" id="vo">
			<article class="am-comment" data-comment-id="{$vo.comment_id}">
			  <a href="{:U('User/index','user_id='.$vo['user_id'])}">
			    <img class="am-comment-avatar" alt=""/> <!-- 评论者头像 -->
			  </a>

			  <div class="am-comment-main">
			    <header class="am-comment-hd">
			      <div class="am-comment-meta am-fl">
			        <a href="{:U('User/index','user_id='.$vo['user_id'])}" class="am-comment-author"><span class="am-text-warning">@{$vo.user_id|get_nickname}</span></a>
			        评论于 {$vo.create_time|get_timing}前
			      </div>
			      <if condition="get_auth('manage_comment', 0, $vo['comment_id'])">
			      <div class="am-fr am-vertical-align">
			      	<button class="am-text-sm am-vertical-align-middle am-badge" onclick="delComment({$vo.comment_id});" style="margin-right: 1rem;">删除该条 <i class="am-icon-times"></i></button>
			      </div>
			      </if>
			    </header>

			    <div class="am-comment-bd" style="background-color: rgba(0,0,0,0.4);">{$vo.detail}</div>
			  </div>
				<br />
			</article>
			</volist>

			<form class="am-form" data-am-validator>
				<fieldset>
				<div class="am-form-group">
		      <label for="doc-ta-1">我要吐槽 <span class="am-text-sm am-text-warning">请合理吐槽</span></label>
		      <textarea id="doc-ipt-comment" minlength="2" maxlength="255" rows="3" placeholder="请不要超过255字"></textarea>
					<input type="hidden" value="{$data.share_id}" name="share_id"></input>
		    </div>
				<input type="submit" class="am-btn am-btn-primary" value="吐" onclick="return submitComment()"></input>
				</fieldset>
			</form>

    </div>
  </div>

  <div class="am-u-md-4 blog-sidebar user-info">
    <div class="am-panel-group">
      <section class="am-panel am-panel-default">
        <div class="am-panel-hd">
        	<span class="am-badge-primary am-badge">{$data.user_id|get_usergroup=0}</span> <a href="{:U('User/index','user_id'.$data['user_id'])}">@{$data.user_id|get_nickname}</a><br />
        	<span class="am-text-sm">关注：{$user.like|default='0'} 粉丝：{$user.be_like} 分享：{$user.total_share}</span>
        </div>
        <div class="am-panel-bd">
          <p class="detail">{$user.detail|default="碎片主人很懒，什么也没有留下。"}</p>
        </div>
      </section>
    </div>
  </div>
</div>

</div>
</block>

<block name='js'>
<script type="text/javascript" src="__PUBLIC__/js/jquery.imgbox.js"></script>

<script type="text/javascript">
(function($) {
	$("#imgbox").attr('detail', $("#imgbox-info").html() );
	$("#imgbox").imgbox();
})(jQuery);

function delComment(comment_id) {
	modalConfirm(function() {
		$.ajax({
			type:"post",
			url: ROOT + "/Shard/delete_comment",
			data: {comment_id: comment_id},
			success: function(data) {
				if (data.status) {
					modalPopup('删除成功');
					$("article[data-comment-id="+ comment_id +"]").remove();
				} else {
					modalPopup(data.info, false);
				}
			}
		});
	}, '你确定要删除这条评论吗？');
}

function submitComment() {
	var detail = $("#doc-ipt-comment");
	var share_id = {$data.share_id};
	$.ajax({
		type:"post",
		url: ROOT + "/Shard/submit_comment",
		data: {
			detail: detail.val(),
			share_id: share_id
		},
		success: function(data) {
			if (data.status) {
				modalPopup('评论成功');
				location.reload();
				detail.val('');
			} else {
				modalPopup(data.info, false);
			}
		}
	});
	return false;
}
</script>
</block>
